{% extends 'home/base.html' %}

{% load static %}

{% block head %}

<title>Profile - TonnaMatrix User Profile</title>
<link rel="stylesheet" href="{% static 'home/css/profile.css' %}">
<style>
    .input-field {
        min-width: 213px;
    }
</style>
{% endblock %}


{% block body %}


<div id="alert-area" class="relative m-0 w-[100%] min-[460px]:w-[32%] float-right"></div>
<div class="container light-style container-p-y padding: py-[12px] px-[60px] max-[752px]:p-[22px] min-[980]:w-[80vw] max-[980]:w-[90%] max-[700]:w-[96%]" id="profile-section">
    <h4 class="font-weight-bold py-3 mb-4">
        PROFILE
    </h4>
    <div class="card overflow-hidden">
        <div class="row no-gutters row-bordered row-border-light">
            <div class="col-md-3 pt-0">
                <div class="list-group list-group-flush account-settings-links">
                    <a class="list-group-item list-group-item-action active" data-toggle="list"
                        href="#account-general">Personal detail</a>
                    <!-- <a class="list-group-item list-group-item-action" data-toggle="list"
                        href="#account-change-password">Change password</a>
                    <a class="list-group-item list-group-item-action" data-toggle="list" href="#account-info">Info</a>
                    <a class="list-group-item list-group-item-action" data-toggle="list"
                        href="#account-social-links">Social links</a>
                    <a class="list-group-item list-group-item-action" data-toggle="list"
                        href="#account-connections">Connections</a>
                    <a class="list-group-item list-group-item-action" data-toggle="list"
                        href="#account-notifications">Notifications</a> -->
                </div>
            </div>
            <div class="col-md-9">
                <div class="tab-content">
                    <div class="tab-pane fade active show" id="account-general">
                        <div class="card-body media flex align-items-center gap-4">
                            <img src="https://bootdey.com/img/Content/avatar/avatar1.png" alt class="d-block ui-w-80">
                            <!-- <div class="media-body ml-4">
                                <label class="btn btn-outline-primary">
                                    Upload new photo
                                    <input type="file" class="account-settings-fileinput">
                                </label> &nbsp;
                                <button type="button" class="btn btn-default md-btn-flat">Reset</button>
                                <div class="text-light small mt-1">Allowed JPG, GIF or PNG. Max size of 800K</div>
                            </div> -->
                            {% if verified %}
                            <span class="badge badge-success bg-success align-self-end">Verified</span>
                            {% else %}
                            <span class="badge badge-danger bg-danger align-self-end">UnVerified</span>
                            {% endif %}

                        </div>
                        <hr class="border-light m-0">
                        <div class="card-body">
                            <div class="flex w-100 gap-4 my-4 max-[572px]:flex-col">
                                <div class="form-group">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-control mb-1" value="{{first_name}}"
                                        name="first_name" id="first_name" readonly minlength="3">
                                    <span class="block text-[12px] font-medium py-1 px-[10px] text-[red]"
                                        id="first_name_error"></span>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-control" value="{{last_name}}" name="last_name"
                                        id="last_name" readonly>
                                    <span class="block text-[12px] font-medium py-1 px-[10px] text-[red]"
                                        id="last_name_error"></span>
                                </div>
                            </div>
                            <div class="flex w-100 gap-4 my-4 max-[572px]:flex-col">
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="text" class="form-control" value="{{phone_number}}" name="phone_number"
                                        id="phone_number" maxlength="10" minlength="10" readonly>
                                    <span class="block text-[12px] font-medium py-1 px-[10px] text-[red]"
                                        id="phone_number_error"></span>

                                </div>
                                <div class="form-group">
                                    <label class="form-label">E-mail</label>
                                    <input type="text" class="form-control mb-1" value="{{email}}" id="email" readonly>
                                </div>
                            </div>
                            <!-- <div class="flex w-100 gap-4 my-4">
                                <div class="form-group">
                                    <label class="form-label min-w-[227px]">Date of Birth</label>
                                    <input type="date" class="form-control mb-1" value="{{dob}}" name="dob" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="gender">Gender</label>
                                    <style>
                                        input[type="radio"] {
                                            display: unset;
                                        }
                                    </style>
                                    <div class="flex gap-4 input-field text-[15px] disabled p-2" id="gender">
                                        <span class="flex items-baseline gap-1">
                                            <input type="radio" id="male" value="male" name="gender" readonly>
                                            <label for="male">Male</label>
                                        </span>
                                        <span class="flex items-baseline gap-1">
                                            <input type="radio" name="gender" id="female" value="female"
                                                placeholder="Female" readonly>
                                            <label for="female">Female</label>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group my-4">
                                <label class="form-label">Bio</label>
                                <textarea type="text" class="form-control" name="bio" value="{{bio}}"
                                    readonly></textarea>
                            </div> -->
                        </div>
                    </div>
                    <div class="tab-pane fade" id="account-change-password">
                        <div class="card-body pb-2">
                            <div class="form-group">
                                <label class="form-label">Current password</label>
                                <input type="password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New password</label>
                                <input type="password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Repeat new password</label>
                                <input type="password" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="account-notifications">
                        <div class="card-body pb-2">
                            <h6 class="mb-4">Activity</h6>
                            <div class="form-group">
                                <label class="switcher">
                                    <input type="checkbox" class="switcher-input" checked>
                                    <span class="switcher-indicator">
                                        <span class="switcher-yes"></span>
                                        <span class="switcher-no"></span>
                                    </span>
                                    <span class="switcher-label">Email me when someone comments on my article</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="switcher">
                                    <input type="checkbox" class="switcher-input" checked>
                                    <span class="switcher-indicator">
                                        <span class="switcher-yes"></span>
                                        <span class="switcher-no"></span>
                                    </span>
                                    <span class="switcher-label">Email me when someone answers on my forum
                                        thread</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="switcher">
                                    <input type="checkbox" class="switcher-input">
                                    <span class="switcher-indicator">
                                        <span class="switcher-yes"></span>
                                        <span class="switcher-no"></span>
                                    </span>
                                    <span class="switcher-label">Email me when someone follows me</span>
                                </label>
                            </div>
                        </div>
                        <hr class="border-light m-0">
                        <div class="card-body pb-2">
                            <h6 class="mb-4">Application</h6>
                            <div class="form-group">
                                <label class="switcher">
                                    <input type="checkbox" class="switcher-input" checked>
                                    <span class="switcher-indicator">
                                        <span class="switcher-yes"></span>
                                        <span class="switcher-no"></span>
                                    </span>
                                    <span class="switcher-label">News and announcements</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="switcher">
                                    <input type="checkbox" class="switcher-input">
                                    <span class="switcher-indicator">
                                        <span class="switcher-yes"></span>
                                        <span class="switcher-no"></span>
                                    </span>
                                    <span class="switcher-label">Weekly product updates</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="switcher">
                                    <input type="checkbox" class="switcher-input" checked>
                                    <span class="switcher-indicator">
                                        <span class="switcher-yes"></span>
                                        <span class="switcher-no"></span>
                                    </span>
                                    <span class="switcher-label">Weekly blog digest</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="text-right mt-3" id="edit">
        <button type="button" class="btn btn-primary" onclick="enableEditing()">Edit</button>
    </div>
    <div class="text-right mt-3" id="cancel">
        <button type="button" class="btn btn-primary" onclick="saveChanges()">Save changes</button>&nbsp;
        <button type="button" class="btn btn-default" onclick="disableEditing()">Cancel</button>
    </div>
</div>

<script>
    const fname = document.getElementById('first_name')
    const lname = document.getElementById('last_name')
    const phone_number = document.getElementById('phone_number')
    const cancel = document.getElementById('cancel')
    const edit = document.getElementById('edit')
    cancel.style.display = 'none';



    function enableEditing() {
        fname.readOnly = false;
        lname.readOnly = false;
        phone_number.readOnly = false;
        edit.style.display = 'none';
        cancel.style.display = 'block';
    }
    function saveChanges() {
        if (checkProfileForm()) {
            const changes = {
                first_name: fname.value,
                last_name: lname.value,
                phone_number: phone_number.value
            }
            console.log(changes)
            updateProfile(changes);
            disableEditing(1)
        }
    }
    function disableEditing(d = 0) {
        fname.readOnly = true;
        lname.readOnly = true;
        phone_number.readOnly = true;
        edit.style.display = 'block';
        cancel.style.display = 'none';
        if (!d) getProfile()
    }

    async function getProfile() {
        const profile = await (await fetch('/api/profile/')).json();
        if (profile.success) {
            const { verified, ...data } = profile.data;
            console.log(data)
            for (const key in data) {
                document.getElementById(key).value = data[key];
            }
        }
        else {
            showAlert('error', 'Failed to load profile.');
        }
    }
    async function updateProfile(data) {
        try {
            const profile = await (await fetch('/api/profile/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })).json();
            console.log(profile)
            if (profile.success) {
                const { verified, ...data } = profile.data;
                console.log(data)
                for (const key in data) {
                    const inpt_field = document.getElementById(key)
                    inpt_field.value = data[key];
                    inpt_field.style.borderColor = '#ced4da';

                }
                showAlert('success', profile.message);
            }
            else {
                for (const e of profile.message) {
                    showAlert('error', e);
                }
            }
        }
        catch (err) {
            showAlert('error', 'Failed to update profile.');
        }
    }

    function checkProfileForm() {
        let fname_error = document.getElementById('first_name_error');
        let lname_error = document.getElementById('last_name_error');
        let phone_number_error = document.getElementById('phone_number_error');
        let flags = [false, true, false]

        // check first name
        if (fname.value.length < 3) {
            fname.style.borderColor = 'Red';
            flags[0] = false;
            fname_error.innerHTML = "First Name must have 3 or more characters";
        }
        else if (fname.value.trim().search(/^[a-zA-Z]{3,}$/)) {
            fname.style.borderColor = 'Red';
            flags[0] = false;
            fname_error.innerHTML = "First Name must have alphabets only";
        }

        else {
            fname.style.borderColor = 'green';
            fname_error.innerHTML = "";
            flags[0] = true;
        }

        // check last name if given
        if (lname.value.length) {
            let last_name = lname.value.trim()
            if (last_name.search(/^[a-z\sA-Z]{2,}$/) !== 0 || last_name.search(/\s{2,}/) !== -1) {
                lname.style.borderColor = 'Red';
                flags[1] = false;
                lname_error.innerHTML = "Remove extra spaces or number from Last Name";
            }

            else {
                lname.style.borderColor = 'green';
                lname_error.innerHTML = "";
                flags[1] = true;
            }
        }
        else {
            lname.style.borderColor = 'grey';
            lname_error.innerHTML = "";
            flags[1] = true;
        }

        // check phone
        if (!phone_number.value.length) {
            phone_number.style.borderColor = 'Red';
            flags[2] = false;
            phone_number_error.innerHTML = "Please enter phone number";
        }
        else if (phone_number.value.search(/^\d{10}$/) === -1) {
            phone_number.style.borderColor = 'Red';
            flags[2] = false;
            phone_number_error.innerHTML = "Please enter a valid phone number";
        }
        else {
            phone_number.style.borderColor = 'green';
            phone_number_error.innerHTML = "";
            flags[2] = true;
        }
        return flags[0] && flags[1] && flags[2];
    }

    async function showAlert(type, message) {
        const alert = `<div class="alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show w-100 py-[10px] px-[25px] absolute" role="alert">
<strong>${type[0].toUpperCase()}${type.slice(1)} : </strong >${message}
<button type="button" class="close float-right" data-dismiss="alert" aria-label="Close" onclick="this.parentNode.remove(true)">
  <span aria-hidden="true" class="text-[30px]">&times;</span>
</button>
</div >`
        const alerts = document.getElementById('alert-area')
        alerts.innerHTML += alert;
        const dismiss_alert = alerts.lastChild
        setTimeout(() => dismiss_alert.remove(true), 5000);
    }

</script>

{% endblock %}